<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Report">
	<resultMap id="purRequestResultSet" type="PurRequest">
		<result property="rptNo" column="RPT_NO"></result>
		<result property="ino" column="INO"></result>
		<result property="cnCode" column="CN_CODE"></result>
		<result property="amount" column="AMOUNT"></result>
		<result property="totPrice" column="TOT_PRICE"></result>
		<result property="purRsn" column="PUR_RSN"></result>
		<result property="deptNo" column="DEPT_NO"></result>
		<result property="mName" column="NAME"></result>
		<result property="rptDate" column="RPT_DATE"></result>
		<result property="sName" column="NAME"></result>
		<result property="title" column="RPT_TITLE"></result>
		<result property="type" column="TYPE"></result>
		<result property="cname" column="CN_NAME"></result>
		<result property="iname" column="INAME"></result>
		<result property="mfg" column="MFG"></result>
		<result property="vos" column="VOS"></result>
	</resultMap>

	<resultMap type="com.kh.hotels.mngApproval.model.vo.Report"
		id="resultSetReport">

		<id property="rptNo" column="RPT_NO" />
		<result property="rptNo" column="RPT_NO" />
		<result property="mno" column="MNO" />
		<result property="rptDate" column="RPT_DATE" />
		<result property="receiver" column="RECEIVER" />
		<result property="rptTitle" column="RPT_TITLE" />
		<result property="rptStatus" column="RPT_STATUS" />
		<result property="apprDate" column="APPR_DATE" />
		<result property="docNo" column="DOC_NO" />
		<result property="rptType" column="RPT_TYPE" />

	</resultMap>

	<select id="selectApproveList" resultType="java.util.HashMap">

		SELECT ROWNUM RNUM,
		RPT_NO, RMNO, MNAME, RPTDATE, RCEIVER, SNAME, RPTITLE,
		RPSTATUS,
		APPDATE, DOCNO, RPTYPE
		FROM(
		SELECT
		R.RPT_NO AS "RPT_NO", R.MNO AS
		"RMNO", M.NAME "MNAME", R.RPT_DATE AS
		"RPTDATE", R.RECEIVER AS
		"RCEIVER", S.NAME AS "SNAME",
		R.RPT_TITLE AS
		"RPTITLE", R.RPT_STATUS AS
		"RPSTATUS", R.APPR_DATE AS "APPDATE",
		R.DOC_NO AS "DOCNO", R.RPT_TYPE
		AS "RPTYPE"
		FROM REPORT R, MEMBER M,
		(SELECT MNO, NAME
		FROM MEMBER
		WHERE
		MNO IN (SELECT DISTINCT RECEIVER
		FROM REPORT)
		) S
		WHERE R.MNO = M.MNO
		AND
		R.RECEIVER = S.MNO
		ORDER BY RPT_NO ASC)
		ORDER BY RNUM DESC
	</select>

	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM
		Report
	</select>
	<select id="selectFilterListCount" parameterType="String"
		resultType="_int">
		SELECT COUNT(*)
		FROM REPORT
		WHERE RPT_STATUS = #{cateCh}
	</select>
	<select id="selectFilterApproveList" parameterType="String"
		resultType="java.util.HashMap">
		SELECT ROWNUM RNUM,
		R.RPT_NO AS "RPT_NO", R.MNO AS "RMNO",
		M.NAME "MNAME", R.RPT_DATE AS
		"RPTDATE", R.RECEIVER AS "RCEIVER",
		S.NAME AS "RNAME",
		R.RPT_TITLE AS "RPTITLE", R.RPT_STATUS AS
		"RPSTATUS", R.APPR_DATE AS "APPDATE",
		R.DOC_NO AS "DOCNO", R.RPT_TYPE
		AS "RPTYPE"
		FROM REPORT R, MEMBER M, (SELECT MNO, NAME
		FROM MEMBER
		WHERE
		MNO IN (SELECT DISTINCT RECEIVER
		FROM REPORT)
		) S
		WHERE R.MNO = M.MNO
		AND
		R.RECEIVER = S.MNO
		AND RPT_STATUS = #{cateCh}
		ORDER BY ROWNUM DESC
	</select>
	<select id="selectApproveDetail" parameterType="_int"
		resultType="java.util.HashMap">
		SELECT R.DOC_NO AS "DOCNO", D.DEPT_NAME AS "DNAME", M.NAME
		AS "MNAME", R.RPT_DATE AS "RDATE", S.NAME AS "SNAME",
		RPT_TITLE AS
		"RTITLE", ROWNUM RNUM, I.INAME AS "INAME", PE.AMOUNT AS
		"AMOUNT",IT.LCATEGORY AS "LCATEGORY",
		I.VOS AS "VOS", PE.TOT_PRICE AS
		"TPRICE", PE.PUR_RSN AS "PRSN", R.RPT_STATUS AS "RSTATUS", I.UP AS
		"UP", IT.TYPE AS "ITYPE", C.CN_NAME AS "CNAME", I.MFG AS "MFG"
		FROM
		REPORT R, PUR_REQ PE, MEMBER M, ITEM I,
		DEPT D, STAFF ST,
		ITEM_TYPE IT,
		CONN C, (SELECT
		MNO, NAME
		FROM MEMBER
		WHERE MNO IN
		(SELECT DISTINCT
		RECEIVER
		FROM REPORT)
		) S
		WHERE R.MNO = M.MNO
		AND
		R.RECEIVER = S.MNO
		AND
		M.MNO = ST.MNO
		AND I.CN_CODE = C.CN_CODE
		AND ST.DEPT_NO = D.DEPT_NO
		AND
		R.RPT_NO =
		PE.RPT_NO
		AND
		PE.INO = I.INO
		AND I.TYPE_NO = IT.TYPE_NO
		AND
		PE.RPT_NO =
		#{rptNo}

	</select>
	<select id="selectApproveRepairDetail" parameterType="_int"
		resultType="java.util.HashMap">
		SELECT R.DOC_NO AS "DOCNO", D.DEPT_NAME AS "DNAME", M.NAME
		AS "MNAME",
		R.RPT_DATE AS "RDATE", S.NAME AS "SNAME",
		RPT_TITLE AS
		"RTITLE", ROWNUM
		RNUM, I.INAME AS "INAME", IT.LCATEGORY AS "LCATEGORY",
		I.VOS AS "VOS",
		RR.TOT_PRICE AS "TPRICE", RR.REP_RSN AS "RSN",
		R.RPT_STATUS AS
		"RSTATUS", I.UP AS "UP",
		RR.CN_CODE AS "CCODE",
		RR.REP_PRICE AS "RPRICE", CON.CN_NAME AS "CNAME", RR.INO
		AS
		"INO",IT.TYPE AS "ITYPE"
		FROM
		REPORT R, REP_REQ RR, MEMBER M, ITEM I,
		DEPT D, STAFF ST,
		ITEM_TYPE IT,
		CONN CON, (SELECT
		MNO, NAME
		FROM MEMBER
		WHERE MNO IN
		(SELECT DISTINCT
		RECEIVER
		FROM REPORT)
		) S
		WHERE R.MNO = M.MNO
		AND
		R.RECEIVER = S.MNO
		AND
		M.MNO = ST.MNO
		AND ST.DEPT_NO = D.DEPT_NO
		AND
		R.RPT_NO = RR.RPT_NO
		AND
		RR.INO = I.INO
		AND I.TYPE_NO = IT.TYPE_NO
		AND
		RR.CN_CODE = CON.CN_CODE
		AND RR.RPT_NO = #{rptNoi}
	</select>
	<select id="selectApproveOrderDetail" parameterType="_int"
		resultType="java.util.HashMap">
		SELECT R.DOC_NO AS "DOCNO", D.DEPT_NAME AS "DNAME", M.NAME
		AS "MNAME", R.RPT_DATE AS "RDATE", S.NAME AS "SNAME",
		RPT_TITLE AS
		"RTITLE", ROWNUM RNUM, I.INAME AS "INAME", ORQ.AMOUNT AS
		"AMOUNT",IT.LCATEGORY AS "LCATEGORY",
		I.VOS AS "VOS", ORQ.TOT_PRICE AS
		"TPRICE", ORQ.ORDER_RSN AS "ORSN", R.RPT_STATUS AS "RSTATUS", I.UP AS
		"UP",
		CON.CN_NAME AS "CNAME",IT.TYPE AS "ITYPE", I.MFG AS "MFG"
		FROM
		REPORT R, ORDER_REQ
		ORQ, MEMBER M,
		ITEM I, DEPT D, STAFF ST, ITEM_TYPE
		IT, CONN CON,
		(SELECT
		MNO, NAME
		FROM MEMBER
		WHERE MNO IN (SELECT DISTINCT
		RECEIVER
		FROM
		REPORT)
		) S
		WHERE
		R.MNO = M.MNO
		AND R.RECEIVER = S.MNO
		AND
		M.MNO = ST.MNO
		AND ST.DEPT_NO =
		D.DEPT_NO
		AND R.RPT_NO = ORQ.RPT_NO
		AND
		ORQ.INO = I.INO
		AND I.TYPE_NO =
		IT.TYPE_NO
		AND ORQ.CN_CODE = CON.CN_CODE
		AND ORQ.RPT_NO =
		#{rptNo}
	</select>

	<select id="selectApproveInfo" resultType="java.util.HashMap">
		SELECT M.NAME AS
		"NAME", S.MNO AS "SMNO",
		STF_ID, S.AUTH_NO, S.DEPT_NO, D.DEPT_NAME AS
		"DNAME"
		FROM MEMBER M
		JOIN STAFF S ON (M.MNO = S.MNO)
		JOIN DEPT D ON
		(S.DEPT_NO
		= D.DEPT_NO)
		JOIN AUTH A ON (S.AUTH_NO = A.AUTH_NO)
		WHERE
		A.AUTH_NO =
		'AUTH2'
		AND D.DEPT_NO = 2
		AND STF_ID != 'master'
	</select>
	<!-- <select id="selectVos" parameterType="String" resultType="_int"> SELECT 
		VOS </select> -->

	<select id="selectConnName" parameterType="String"
		resultType="java.util.HashMap">
		SELECT DISTINCT CN_NAME
		FROM ITEM_TYPE IT
		JOIN ITEM I
		ON(IT.TYPE_NO=I.TYPE_NO)
		JOIN CONN C ON(I.CN_CODE = C.CN_CODE)
		WHERE
		IT.TYPE = #{value}
	</select>
	<select id="selectItemName" parameterType="PurRequest"
		resultMap="purRequestResultSet">
		SELECT INAME, INO
		FROM (SELECT INAME, MAX(INO) AS "INO"
		FROM CONN C
		JOIN ITEM I ON(C.CN_CODE = I.CN_CODE)
		WHERE MFG = #{mfg}
		AND CN_NAME = #{cname}
		GROUP BY INAME)
	</select>
	<select id="selectMadeComName" parameterType="String"
		resultType="java.util.HashMap">
		SELECT DISTINCT MFG
		FROM ITEM I
		JOIN CONN C ON(I.CN_CODE = C.CN_CODE)
		WHERE C.CN_NAME = #{value}
	</select>
	<select id="selectVosPrice" resultType="java.util.HashMap"
		parameterType="String">

		SELECT VOS, INO
		FROM (SELECT VOS, MAX(INO) AS "INO"
		FROM ITEM I
		JOIN ITEM_TYPE IT ON(I.TYPE_NO = IT.TYPE_NO)
		JOIN CONN C ON (I.CN_CODE =
		C.CN_CODE)
		WHERE INAME = #{iname}
		AND TYPE = #{type}
		AND CN_NAME =
		#{cnName}
		AND MFG = #{madeComName}
		GROUP BY VOS)

	</select>

	<!-- 구매요청서 입력 쿼리문 -->
	<select id="insertPurchaseApproveList"
		parameterType="PurRequest">
		INSERT INTO REPORT (RPT_NO, MNO, RPT_DATE, RECEIVER, RPT_TITLE, RPT_STATUS,
		APPR_DATE, DOC_NO, RPT_TYPE)
		VALUES(SEQ_RPT_NO.NEXTVAL, #{mmno}, #{rptDate}, #{smno}, #{title}, DEFAULT, DEFAULT, #{docno},
		'PURCHASE')
	</select>
	<!-- rptno가져오기 -->
	<select id="selectRptNo" parameterType="_int" resultType="_int">
		SELECT RPT_NO
		FROM REPORT
		WHERE DOC_NO = #{docNo}
	</select>
	<!-- 구매요청서 값 insert -->
	<select id="insertPurRequest" parameterType="PurRequest">
		INSERT INTO PUR_REQ(INO, AMOUNT, TOT_PRICE, PUR_RSN, RPT_NO)
		VALUES(#{ino}, #{amount}, #{totPrice}, #{content}, #{rptNo})
	</select>
	<select id="selectRepairIname" parameterType="_int"
		resultType="String">
		SELECT INAME
		FROM ITEM
		WHERE INO = #{ino}
	</select>

</mapper>
  
  